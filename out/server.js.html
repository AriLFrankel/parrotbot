<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: server.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: server.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file node server for receiving Slack events
 * https://api.slack.com/events-api
*/
const http = require('http');
const { createMessageApi: createMessage, postMessage } = require('./bot');
const { consoleOut } = require('./util');

const { BOT_ID: botId } = process.env;
const cache = new Set();

/**
 * A helper function for determining if a request is a challenge from Slack
 * @param {object} body
 * @returns {boolean}
 */
const isChallenge = body => Boolean(body.challenge);

/**
 * A helper function for identifying parrot requests
 * and the target users of such requests
 * @param {object} event
 * @returns {object} event with target property added
 */
const findParrotRequest = (event) => {
  const r = new RegExp(`&lt;@${botId}> parrot &lt;@\\w{9}>`);
  return Object.assign(event, {
    target: r.test(event.text)
      ? event.text.match(/&lt;@\w{9}>(?!.*&lt;@\w{9}>)/)
      : null,
  });
};

/**
 * A helper function for parsing JSON request bodies.
 * @param {object} request
 * @param {object} response
 * @param {function} callback
 */
const parseJSONBody = (request, response, callback) => {
  let body = [];
  request.on('data', (chunk) => {
    body.push(chunk);
  }).on('end', () => {
    body = Buffer.concat(body).toString();
    try {
      body = JSON.parse(body);
      callback(body);
    } catch (err) {
      response.statusCode = 401;
      response.end('come back with JSON');
    }
  });
};

const addRequestErrorHandler = r => r.on('request error', console.error);

/**
 * A function for attempting to generate a message imitating the user
 * and post it to the channel
 * @param {string} user
 * @param {string} channel
 */
const createAndPostMessage = (user, channel) => {
  const userId = user[0].slice(2, 11);
  return createMessage({ id: userId }, {}, (error, result) => {
    if (result) {
      return postMessage(result, channel, consoleOut);
    }
    console.error(error);
    return postMessage('sorry something went wrong', channel, consoleOut);
  });
};

const handleBadFormat = channel => postMessage('Please use the following format to request that I parrot someone, \n `@parrotbot parrot @PERSON`', channel, consoleOut);

const port = process.env.PORT || 8080;
// eslint-disable-next-line consistent-return
http.createServer((request, response) => {
  const { method } = request;
  if (method !== 'POST') {
    return response.end('I can only accept post requests');
  }
  addRequestErrorHandler(request);
  parseJSONBody(request, response, (body) => {
    // handle challenges
    if (isChallenge(body)) {
      response.setHeader('Content-Type', 'application/x-www-form-urlencoded');
      return response.end(body.challenge);
    }
    const { event, event_id: eventId } = body;
    // do caching
    if (cache.has(eventId)) return null;
    cache.add(eventId);
    // handle Parrot requests
    const { channel, target } = findParrotRequest(event);
    if (target !== null) return createAndPostMessage(target, channel);
    return handleBadFormat(channel);
  });
}).listen(port, () => console.log(`listening on ${port}`));
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#capitalize">capitalize</a></li><li><a href="global.html#createAndPostMessage">createAndPostMessage</a></li><li><a href="global.html#createMessage">createMessage</a></li><li><a href="global.html#findParrotRequest">findParrotRequest</a></li><li><a href="global.html#flatten">flatten</a></li><li><a href="global.html#getAllMessages">getAllMessages</a></li><li><a href="global.html#getChannels">getChannels</a></li><li><a href="global.html#getMessages">getMessages</a></li><li><a href="global.html#getUser">getUser</a></li><li><a href="global.html#isChallenge">isChallenge</a></li><li><a href="global.html#parseCorpus">parseCorpus</a></li><li><a href="global.html#parseJSONBody">parseJSONBody</a></li><li><a href="global.html#pluck">pluck</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sun Mar 04 2018 21:50:49 GMT-0600 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
